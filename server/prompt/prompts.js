/**
 * 提示词管理模块
 * 包含：规则内容、提示词生成逻辑
 * 所有提示词相关配置集中在服务端，方便热更新
 */

// ==================== 问题分类与规则映射 ====================

const CATEGORY_RULE_MAP = {
  '综合': 'nianyun',
  '健康类': 'jiankang',
  '事业类': 'shiye',
  '财运类': 'caiyun',
  '感情类': 'ganqing',
  '投资类': 'gushi',
  '学业类': 'shengxue',
  '其他类': 'qita'
};

// ==================== 规则内容 ====================

// 财运规则 (rule1-caiyun)
const RULE_CAIYUN = `# 算卦财运实战补充观点

## 一、运势与求财关系核心理论汇总

### 1. 世爻根基理论：财爻持世与日月的辩证
- **核心准则**：运势占断首看世爻。财爻持世（未土）虽主求财易得，但若遭日月（子月、寅日）克泄，代表当下处境艰难、根基不稳。
- **借鉴意义**：莫因"财爻持世"而盲目乐观；世爻休囚则抗风险能力弱，需外力生扶。

### 2. "通关"救局理论：子孙爻的转化力量
- **核心准则**：见兄弟克世财（卯木克未土）凶兆时，必须看**子孙爻（午火）**状态。
- **实战逻辑（贪生忘克）**：
  - 兄弟单动：破财、竞争、小人劫掠。
  - 子孙同动：兄弟"贪生"子孙而"忘克"世财，子孙转而生世。
- **借鉴意义**：危机时别硬刚，靠"子孙"（技术创新/第三方中介/营销创意）把压力转成生财源泉。

### 3. "内外平衡"理论：内部波折与外部应期
- **核心准则**：
  - 内卦动（三爻卯木）：内部矛盾（合伙反目、内耗、近亲借贷、管理成本激增）。
  - 外卦动（四爻午火）：外部转机（新市场利好、远方贵人、政策红利）。
- **借鉴意义**：内部虽损但外部有应，定性"先忧后喜"；胜负手在外卦，只要外卦生世，内部小损可控。

### 4. "化劫为财"与"财化鬼"的对冲
- **核心准则**：
  - 兄化财（四爻午化丑）：竞争者转合作者，或因麻烦意外得利。
  - 兄化鬼（三爻卯化申）：内部纠纷处理不好，易变官非/长期压力（官鬼）。
- **借鉴意义**：得财同时防"因财生官非"，尤其申金出空时更要警惕。

## 二、交易求财类卦理核心理论汇总

### 1. 兄弟持世：定性为"财之劫难"
- **核心准则**：占交易求财最忌兄弟持世；兄弟为妻财克星，象征竞争者、中间人、开销、损耗、甚至骗局。
- **借鉴依据**：哪怕卦名再吉，只要兄弟持世且发动，这钱难"入库"，利润被稀释/瓜分。

### 2. 化退神：定性为"后劲不足"与"主动让渡"
- **核心准则**：世爻发动化退神（辰化丑）= 发展力量衰减。
- **交易映射**：心态退缩、竞争力下降、被迫降价/缩规模。

### 3. "财旺落空"：定性为"有名无实"或"为他人作嫁衣裳"
- **核心准则**：看财爻质量与位置。
  - 财旺：标的真实存在
  - 落空（旬空）：钱不到位或不属我
- **关联结论**：财旺 + 财空 + 兄弟持世 → 项目真，但你忙活，钱被别人拿走。

### 4. 世应生合：定性为"笑里藏刀"的陷阱
- **核心准则**：交易喜应生世，但前提是"财爻有气"且"世爻不被克"。
- **借鉴依据**：兄弟持世时应生世="财被劫而人被合"，对方客气是稳住你让你担风险，核心利益与你无关。

## 三、算财运核心理论汇总

### 1、核心逻辑：内在关系决定论
- 原则：**内在位分决定成败，外在信息定象**。
- 兄弟持世：主要矛盾="劫财"力量，赚钱阻碍重重。
- 阴阳对冲：世爻（水）与伏藏财爻（火）相冲，行为模式与财富目标初期难契合。

### 2、动态转化：从阻碍到机会的推演
- 合住阻碍即机会（寅月）：寅木与亥水六合，兄弟被合住→劫财力失效→出现赚钱窗口。
- 兄弟化子孙（基础）：干扰通过中介（产品/服务）转化为机会，卯月填实根基。
- 目标落地（巳月）：才爻属火，巳月为见财终点。

### 3、实战应对与空间布局
- **时机策略**：寅月抓机会；卯月夯实基础；巳月收获期。
- **空间布局**：才爻属火 → 布局南方借力（火旺压水劫）。

### 4、总结断卦公式（未来参考）
- 首辨位分：见兄弟持世先定"损耗与阻碍"，再看月日合住救应。
- 次察动变：找"兄弟化子孙"出口。
- 合处逢生：能合住阻碍的月份=转机/机会点。
- 定向布局：以才爻五行定方位补强。`;

// 升学规则 (rule2-shengxue)
const RULE_SHENGXUE = `# 六爻规则（升学、学业）

## 算卦升学和学业实战补充观点

## 一、学业与升学占断核心理论汇总

### 1. 用神定性：父母为印，官鬼为源
- **父母爻（用神）**：代表学业、成绩、考试卷、录取通知书以及学校。
- **官鬼爻（原神）**：代表名次、地位、考试的动力以及通向学校的桥梁（官能生印）。
- **实战准则**：只有"官印相生"（官鬼发动生父母），才是名标金榜、稳上名校的铁证。

### 2. 生克链条阻断理论
- **子孙克官**：子孙是学业的"忌神"。若子孙旺动（如"子水、亥水齐动"）克掉官鬼，则代表：
  - **学生心态**：厌学、贪玩、心思不在书本上，或临场极度排斥考试。
  - **逻辑断点**：官鬼被克 → 父母印星失去生助源头（无源之水）→ 成绩远低于预期。
- **官不生印**：若官鬼动而化回头克，或被月令冲破，则官星无力，无法起到衔接作用，主名次不佳。

### 3. 空间方位与外部干预（内外卦论）
- **内三爻（内部）**：代表学生自身实力与心态；二爻动被回头克，说明自学能力或内部状态出了大问题。
- **外三爻（外部）**：代表录取环境、政策与人事干预；六爻动克官，说明外部竞争压力极大，甚至有政策性排斥。
- **实战修正**：若内外皆现"克局"，仅靠学生自己努力已无法挽回，必须引入外部变量。

### 4. "财、官、印"转化的救局策略
- **核心理论**：子孙（玩乐/阻碍）太旺时，用"妻财"去泄子孙之气，转而生官。
- **实战结论**：这种情况靠硬考不行，需要"费一定人事努力或财力"。
- **路径**：
  - 财生官：投入资源。
  - 官生印：疏通关系或寻找特殊录取通道。

## 二、未来借鉴：决策与应期准则

| 要素特征 | 实战结论 | 行为建议 |
|---|---|---|
| 父母印星失地/弱 | 考试运势低迷 | 调理书房风水（补土），或降低报考预期 |
| 子孙发动/月破官星 | 考运被截断 | 严防孩子分心；检查是否有外界干扰导致厌学 |
| 官鬼动化回头克 | 动力衰竭 | 寻找"通关"之物，如木火属性环境或导师 |
| 六冲/蹇卦背景 | 过程极其艰难 | 做好打持久战或走弯路的心理准备 |
| 应期判定 | 五行补足原则 | 官鬼被冲破，需待官星旺相之季（夏季）方有转机 |`;

// 事业运势规则 (rule3-shiye)
const RULE_SHIYE = `# 六爻规则（事业运势）

## 一、合作做生意

### 1）合伙速成与"激/转"两法
- **兄弟持世 / 应化兄弟**：若逢**日建冲空**，多主**速成**之象。
- **官鬼动临朱雀**：不必一概言官非，更像是**管理者疑虑/审核质疑**。
- **官鬼化兄弟**：主**贵人折节下交**，或"管理层融入执行层/纳入团队"。
- **术语**：
  - 空逢日冲谓之 **"激"**（当日即发、推进很快）
  - 鬼化兄弟谓之 **"转"**（疑虑转为接纳/落地执行）
- **结论**：虽有口舌微言，但**利必分、事必就**。

### 2）比劫合伙论：修正"见兄必克财"
- **世应皆兄弟且比和**：可视为**团队同心、资源共享**（不再机械判"克财"）。
- **官鬼转化论**：官鬼动化兄弟 → "祸"转为"**审核通过后的接纳/管理融入**"。
- **朱雀沟通论**：朱雀主口舌，重在**沟通/信息传递/谈判表达**。
- **日建激发行**：旬空之爻逢日冲，不按"出空"论期，按**当日即发**论急。
- **空亡心理学**：旬空不止"事无成"，也代表当事人**观望、未定、摇摆**。

## 二、求职与事业决策：实战占断核心理论汇总

### 1）用神辨析：职位（名）与生计（利）
- **父母爻为用（求名）**：问具体职位、聘书、录取通知、编制。父母旺相 → 单位好/信息实；父母受克 → 文书受阻/不被录取。
- **妻财爻为用（求利）**：问薪资待遇、生意营谋、创业获利。
- **核心逻辑**：先分清求测者要的是"聘书（父母）"，还是"赚到钱（妻财）"。

### 2）"世克用神"：心不甘情不愿论
- 世爻代表求测者，用神代表目标职位。
- 若**世克用神**（例：未土克父母子水），即使用神值月极旺，也定性为**"有缘无份 / 得而不乐"**。
- 现实表现：主观挑剔、对职位不满、入职后心态失衡，或姿态过高导致关系不稳（常伴变卦六冲）。

### 3）"财克父"：弃职从商的转型信号
- 财爻发动/持世会产生"**贪财坏印（克父）**"。
- 建议果断转型的组合：
  - 求职受阻：世克父母或父母受冲克；
  - 财源茂盛：子孙爻（原神）发动且得日/月生助；
  - 生财链条成：子孙生世爻妻财，形成完整相生。
- 结论：此时"文书（工作）"成压力，"子孙（项目/创意）"为生机。

### 4）"子孙持世/生世"：自由职业与创业基因
- 子孙爻：剥官之神，也是生财之源。
- 问求职见子孙动/持世：多主变动、不安于位、辞职、对领导不服。
- 问创业见子孙动/持世：主生意兴隆、客源不断、有核心技术、思路清晰。

## 三、开张卦理核心理论汇总

### 1）福神（子孙）绝对核心论
- 开店不单看财爻，更要看**子孙爻（福神）**：顾客、口碑、财源、消灾之神。
- 只要子孙旺相（如亥水值月），即便世受克或有官鬼骚扰，也主"有惊无险、源远流长"。

### 2）"兄动生福"转化理论
- 兄弟动通常主劫财/竞争；但若**兄动生子孙**，则凶转吉。
- 现实映射：化竞争为动力；同行竞争反引流，或前期投入换来口碑。

### 3）"合世"定性理论（子丑合）
- 世爻被月建/日建生合（如子日合丑土世）主"稳/固"。
- 开张卦喜合不喜冲：合=人心齐、客源稳、扎根深。

### 4）"官鬼受制"保护理论
- 变卦官鬼回头克世或劫财时，需依靠子孙之力制衡。
- 子孙旺→公关/抗风险强；择子孙旺地（亥、子日）本质是"压制官鬼、保护财路"。`;

// 流年运势规则 (rule4-nianyun)
const RULE_NIANYUN = `# 六爻规则（流年运势）

## 一、运势与求财关系核心理论汇总

### 1）世爻根基理论：财爻持世与日月的辩证
- **核心准则**：运势占断首看世爻。财爻持世（未土）虽主求财易得，但若遭日月（子月、寅日）克泄，代表当下处境艰难、根基不稳。
- **借鉴意义**：莫因"财爻持世"而盲目乐观；若世爻休囚，代表空有获利之心但抗风险能力弱，需要外力生扶。

### 2）"通关"救局理论：子孙爻的转化力量
- **核心准则**：当卦中出现兄弟克世财（卯木克未土）的凶兆时，必须观察**子孙爻（午火）**的状态。
- **实战逻辑（贪生忘克）**：
  - 兄弟单动：破财、竞争、小人劫掠。
  - 子孙同动：兄弟"贪生"子孙而"忘克"世财，子孙转而生世。
- **借鉴意义**：危机出现时（兄弟动）不宜硬碰硬，应引入"子孙"（技术创新、第三方中介、新营销创意），把压力转化为生财源泉。

### 3）"内外平衡"理论：内部波折与外部应期
- **核心准则**：
  - 内卦动（三爻卯木）：内部矛盾（合伙反目、部门内耗、近亲借贷、管理成本激增）。
  - 外卦动（四爻午火）：外部转机（新市场利好、远方贵人支持、政策红利）。
- **借鉴意义**：内部虽有损（劫财），但外部有应（生财），定性"先忧后喜"；胜负手在外卦，只要外卦生世，内部小损不足为虑。

### 4）"化劫为财"与"财化鬼"的对冲
- **核心准则**：
  - 兄化财（四爻午化丑）：外部竞争者转化为合作者，或因麻烦而意外得利。
  - 兄化鬼（三爻卯化申）：内部纠纷若处理不好，易演变为官非或长期精神压力（官鬼）。
- **借鉴意义**：运势有双面性；得财（丑土）的同时，要防因财引官非隐患（申金），尤其申金出空时更要谨慎。

## 二、未来决策模型：从"求职"到"运势"的跨卦关联

> 通过近期几卦连贯分析，形成"生涯转型判定模型"。

| 卦象特征 | 现实映射（借鉴依据） | 决策方向 |
|---|---|---|
| 世克父母 / 父母克世 | 职位与人磁场不合，长辈/官方是阻碍 | 弃职 / 避官 |
| 财爻持世 + 子孙通关 | 自身带财，且具备化危为机、自主经营能力 | 经商 / 创业 |
| 动爻内劫外生 | 内部有小人分利，外部有贵人送钱 | 向外求财，对内谦和 |

## 三、感情/姻缘运势占断要点

### 1）世应关系论
- **世爻**：代表求测者本人
- **应爻**：代表对方或未来伴侣
- 世应相生相合：缘分深厚，关系和谐
- 世应相克相冲：矛盾多，需化解

### 2）用神选取
- 男问女：以妻财爻为用神
- 女问男：以官鬼爻为用神
- 用神旺相：对象条件好
- 用神休囚：对象条件一般

### 3）应期判断
- 用神逢合之时：相遇之期
- 用神逢冲之时：关系变化之期
- 动爻变化：事情发展转折点`;

// 健康规则 (rule5-jiankang)
const RULE_JIANKANG = `# 六爻规则（健康）

## 算卦健康实战补充观点

## 一、占疾病（咳嗽 / 感冒类）核心实战理论汇总

### 1）核心用神重定位
- **世爻为"躯壳"**：代表病人的基本体质与现状。世爻受克（如木克土），主脾胃受困、体力透支。
- **官鬼为"病邪"**：主病灶与症状。六爻官鬼代表头部、咽喉、呼吸道。
- **子孙为"药效 / 抵抗力"**：主自愈能力与医疗手段。变爻或伏神出子孙，代表后续的转机。

### 2）"回头生"是缠绵的关键（本卦精髓）
- **理论**：若官鬼发动，且变爻回头生官鬼（如卯木化子水，水生木），定性为 **"病有根源，经久不愈"**。
- **现实映射**：痰湿源源不断、炎症反复；只要"原神（子水/湿气）"不断，"忌神（卯木/咳嗽）"就不会停——这是区分"偶感"与"缠绵内伤"的金标准。

### 3）脏腑生克链条理论（中医视角）
- 不可孤立看肺（金），要看五行流转：
- **木旺克土**：肝木横逆克脾土，病机为"脾虚湿盛"。
- **脾为生痰之源**：世爻（土）被克，运化失职，湿气化痰上贮于肺。
- **肺为贮痰之器**：子孙（金）暗动代表肺部排痰的本能反应；若土（脾）不生金（肺），则肺气孤立无援，咳嗽难愈。

### 4）"暗动"是绝处逢生的信号
- **理论**：子孙爻虽未发动，但被日建冲起（寅申冲），定性为 **"暗动"**。
- **应用**：代表免疫系统已被激活，虽未掌控局势，但已有"伏兵"。
- **应期判定**：暗动之爻填实之日（申日/酉日）为药到病除、金旺克木之时。

### 5）"静与动"的力量对比
- **世爻静**：病人处于防御、消极或无奈状态，只能被动承受。
- **官鬼动**：病情正在发展、变化中。
- **结论**：世静鬼动，必须借助外力（药物、寻医）打破僵局，不可只靠静养。

## 二、未来借鉴：应期与规避规则

| 状态特征 | 实战结论 | 借鉴依据 |
|---|---|---|
| 官鬼化回头生 | 必有"源头"未断 | 需化痰去湿（断其源），而非单纯止咳 |
| 世爻（土）受克 | 脾胃受损 | 严禁生冷肥腻，需温中健脾 |
| 子孙（金）暗动 | 药效在特定方位 | 往申酉方（正西/西南）寻医问药，庚辛日为转机 |
| 月令生鬼 / 日建冲世 | 此时最重 | 月令给病气"底气"，官鬼值月/日时不可轻敌 |

## 三、重大疾病（积聚类）占断核心理论汇总

### 1）用神定性：子孙持世是"定海神针"
- **核心理论**：占病见子孙持世，为大吉之象。子孙为"福神""解药"，代表免疫系统与自愈能力。
- **实战结论**：子孙旺相（得月生、日建、兄动相生）则 **"命不该绝"**，具备抗争与恢复根基。

### 2）"六冲变六冲"：冲散积聚之邪
- **核心理论**：肿瘤/癌症属"阴邪结聚"，对此类疾病 **"逢冲则散"**。
- **实战结论**：屯卦变坤卦，内外皆冲，能量震荡使结块之邪无法凝聚，易被冲散化掉，是"可治愈"重要形态依据。

### 3）官鬼动变的"方案辨伪"法
- **核心理论**：官鬼代表病情，也代表针对疾病的攻击性手段。
- **实战结论**：官鬼戌土发动变兄弟亥水；若动后不增强病势而"转向"，提示当前治疗方向可能有误，需另寻对症方案（第二意见）。

### 4）"金木刑克"与手术禁忌
- **核心理论**：若用神（子孙）为木，大忌金动。
- **实战结论**：手术属强金；子孙寅木持世时，动刀会重创自愈根基（子孙受损），故"绝对禁忌手术"。

### 5）"孙生财"与胃气判定
- **核心理论**：子孙为妻财原神。子孙持世暗生妻财，代表"胃气尚存"。
- **实战结论**：只要运化（财受生）无碍，能摄取营养支持对抗，因此推导出"无需忌口"（顺应身体需要）的结论。

## 四、未来借鉴：决策与方位准则

| 要素特征 | 实战结论 | 行为建议 |
|---|---|---|
| 子孙持世（旺相） | 免疫力是主导 | 优先选择激发自愈力的疗法（中医/自然疗法等） |
| 六冲卦象 | 结块易散 | 保持信心，配合气机导引/运动辅助"冲散" |
| 鬼化兄弟 | 方案存疑 | 重新审视方案，寻找更对症的第二意见 |
| 用神属木 | 忌金克，喜水生 | 严禁动刀手术；寻医往东/东北；多接触自然 |
| 孙生财爻 | 脾胃生化有源 | 饮食顺应本能，想吃即身体需要，无需刻意禁食 |`;

// 股市规则 (rule6-gushi)
const RULE_GUSHI = `# 六爻算股：大盘 / 行业 / 个股 / 黄金（实战精简体系）

> 核心口径：**官印看天（势）｜世爻定魂（强弱）｜财子看钱（盈利与动能）**  
> 操作口径：**内生外=投入吸筹｜外生内=回笼获利｜避刑=防反复损耗｜择源=锁原神/用神旺时**

---

## 一、算股市大盘走势核心理论汇总（A股大盘算卦实战模型·精简版）

### 1）看"势"：官印旺衰（大盘涨跌）
- **官鬼=政策**；**父母=指数/大盘**
- **官印相生**（或官旺临朱雀）= 政策驱动/指数有撑  
  - 即便财不旺，也可能出现"**虚假繁荣**"或政策性上涨

### 2）看"利"：财爻持世（个人获利）
- **财爻=资金/利润**；**世爻=操作者**
- 财休囚或受克：**指数涨但个人可能亏**
- 财旺相生世：**真金白银能入袋**

### 3）看"机"：子孙发动（入场信号）
- **子孙=财之原神=市场动能/信心**（常与青龙喜悦相应）
- 子孙动：有反弹/有买盘  
- 子孙临青龙：**极佳买点**

### 4）看"转"：内外生克（投入与回收）
- **内卦=己方/资金**；**外卦=市场/产出**
- **内生外**：消耗、入场、吸筹（短期不取）
- **外生内**：产出、回笼、获利（获利撤退）

### 5）择时忌讳：刑冲克害
- 坚决避开 **"相刑"月**（如寅巳相刑）：反复折磨/意外损耗
- 锁定 **"原神/用神值月"**（如卯月、巳月）作为关键节点

---

## 二、算股市行业走势核心理论汇总（"三层四维"框架）

### 1）三层（定大方向）
- **底层（大盘天气）**：官印旺衰  
  - 官印相生 → 政策有支撑，指数安全
- **中层（行业/个股船力）**：世爻强弱  
  - 世旺相 → 独立行情  
  - 世衰弱 → 随波逐流
- **顶层（盈利收成）**：财爻位置  
  - 财生世 → 能赚钱  
  - 财伏藏 → 时机未到

### 2）四维（定操作细节）
- **动能观**：子孙发动=入场信号（买盘信心）
- **流向观**：内生外=吸筹投入期；外生内=利润回收期
- **风险观**：避相刑月（如寅巳相刑）防折磨亏损
- **时间观**：锁定用神/财库值日（如辰月、子月）做进出节点

---

## 三、个股算卦实战经验：全维度研判模型

### 1）世爻定性：个股、利润与政策三位一体
- **世爻=个股本体（营收/利润）**
  - 旺相：基本面强，利润爆发期
  - 休囚/月破：根基不稳、营收受压
- **官鬼持世**：政策背书（真利好支撑，非虚假繁荣）
- **兄弟持世**：劫财与阻力（竞争惨烈，难赚钱）

### 2）动态辨伪：看穿短期走势的虚实
- **父动得时=短期虚涨**（消息/大盘造势）
- **父母生兄弟=诱多**：赚指数不赚钱，辛劳无获
- **父母化财回头克=信息存伪**：不可轻信

### 3）时空择时：三合局与值月/值日法
- **入场（构局）**：锁三合局首字值月入场  
  - 例：寅午戌局 → **寅月**入场（立春后）
- **收割（巅峰）**：合局顶点或财库开启之月离场  
  - 例：**未月/农历六月**收割
- **趋势进退**：内生外=吸筹；外生内=回收离场

### 4）风险规避：刑冲与周期
- 避刑：相刑月（如寅巳相刑）谨防折磨亏损
- 周期：若下半年不利，上半年再强也要在巅峰月后果断离场

---

## 四、黄金/长线标的实战精简模型（"三位一体"）

### 1）定趋势：父母爻为"风向标"
- 父母旺：行情涨势未尽（大环境支撑强）

### 2）定节奏：冲合定"爆发点"
- 世爻逢月令冲实：主升浪最猛（如辰月冲戌土）
- 逢合：技术性调整

### 3）定操作：暗合局为"入场券"
- 找暗藏三合局（如寅午戌）
- 合局首月入；合局巅峰季（多在夏季）了结

### 实战极简口诀（长线版）
- **父母旺，涨不停；三月冲，浪最猛；寅月入，夏收金；合局成，利自盈。**

---

## 五、行业/长线终极"**三阶判准法**"（定性→定量→定时）

### 第一阶：定性（看大卦与世爻）
- 大卦定基石：乾坤稳；六冲变六合=先急后缓
- 世爻定魂魄：旺相利厚；月破根坏
- 官鬼定背书：官鬼持世且旺=政策真支持

### 第二阶：定量（看消息与动能）
- 父母定风向：父旺=势未尽；但**父生兄=诱多陷阱**
- 子孙定动能：子孙动=买盘信心；化退/受克=后劲不足
- 辨伪：回头克 / 兄持世 → 信息存伪或求财难，应撤退

### 第三阶：定时（看合局与流年）
- 合局定切入：三合局首月入场（如寅月）
- 冲实定爆发：世爻逢月令冲实（如辰月）为主升浪爆发点
- 流年定收成：合局巅峰月（如未月）后若形势不稳，春种夏收

### 总口诀（终极版）
- **官印看天，世爻定魂；父动定势，合局定辰。**
- **旺相营收好，兄持白忙贫；外生内获利，避刑退守勤。**`;

// 感情类规则 (rule7-ganqing)
const RULE_GANQING = `# 男女感情 / 姻缘 / 婚姻六爻：实战补充观点（整理版）

---

## 一、增删卜易实战修正：感情占断五大核心铁律

### 1）生克为基：相生则聚，相克则散（最高优先级）
- **优先级原则**：感情占断中，**生克关系优先级最高**，高于动爻形态与卦名义。
- **长久判定**：关系要长久，必须满足 **世应相生** 或 **世用相生**（用神：男占取妻财，女占取官鬼）。
- **相克必终**：若 **世爻与用神（妻财/官鬼）相克**，定性为"无缘"或"因爱生恨"，动变再复杂也难改结局。
- **动变修正**（反常点）：
  - **动化妻财不必然吉**。
  - 若 **兄弟持世化出妻财**：因兄弟本为克财之物，此化出往往是"回头克"，主**强求/占有欲/劫夺**，最终破裂。

### 2）月日权重：月令为纲，日建为目（虚旺识别）
- **月令绝对论**：月令克世、冲世（世月破）= 世爻枯根，根基先坏。
- **日建虚旺论**：世爻被月令冲破，但值日建/得日生 → **虚旺**（表面硬撑）。
- **心态陷阱**：凡遇"月破日扶"：
  - 当事人最易陷入 **迷恋、不甘心、困兽之斗**。
  - 实战建议：**迷恋即惹祸，不可妄动**，以"止"为上。

### 3）用神重叠：双财/双官看心态（看布局，不看取舍）
- **双财/双官**：多主一心二用、逢场作戏、多头关系。
- **关系性质判定**：
  - 若多个用神皆与世爻相克 → 多段关系皆属消耗，无一可成。

### 4）第三方力量：财生官与官护财（色祸识别）
- **名花有主**：
  - 男占若见 **妻财生合月令官鬼**（或伏于官下）→ 对方已有强势伴侣/强背景。
- **色祸定性**：
  - 若世爻月破（己方弱）仍强行去克/占有那"生助官鬼的妻财" → 定性"色祸"，易招**官方压制/报复**或现实层面的强干预。

### 5）终极规避：知止与远离（趋吉避凶为本）
- **官克世 / 兄劫财**：世被克制、被冲破且用神无意生世 → 最佳方案不是求复合，而是**远离**。
- **行为修正**：空间上的**物理隔绝**，是化解"兄弟持世回头克"最有效的策略。

---

## 二、更新后的断卦操作流程（五步法）

| 步骤 | 操作要点 | 逻辑目标 |
|---|---|---|
| 第一步：看世用生克 | 兄弟持世？世克用神？ | 排除强求与内耗 |
| 第二步：校准月日权重 | 是否月破？日扶是否虚旺？ | 识别利令智昏/幻觉 |
| 第三步：普查卦面用神 | 是否双财/双官？ | 识别多角关系 |
| 第四步：扫描第三方 | 用神是否与月令官鬼有情？ | 预判色祸/外部势力 |
| 第五步：定性结论 | 避祸为上 | 以"远离"为终解 |

---

## 三、姻缘关系实战占断核心理论汇总

### 3.1 核心用神与性别差异
- **男求女**：以 **妻财爻** 为用神；辅看 **子孙爻**（财之原神，代表欲望/动力/根基）。
- **女求男**：以 **官鬼爻** 为用神；辅看 **妻财爻**（官之原神，财旺方能生官，代表吸引力与基础）。

### 3.2 "父母克世"：家庭阻碍理论
- **父母爻**：长辈、家庭、门第、文书手续。
- **准则**：父母发动冲克世（如子水克午火）→ 不论初衷，结果定性为 **家庭阻碍/长辈干预**，婚事多波折。

### 3.3 "子孙为根"：桃花根基与虚缘识别
- **子孙**为根基。
- 若子孙被月令冲破（如子月冲午）→ 桃花根坏；即使财动，也多为 **镜花水月**，近期不宜投入。

### 3.4 "午未六合"：应期判定的强信号
- **合**代表契合与落定。
- 男占若 **世为午火（子孙）**，变爻为 **未土（妻财）**，成 **午未六合**：
  - 子孙生财、基础稳，常为**成婚佳象**。

---

## 四、未来借鉴：应期与转化逻辑

| 维度 | 核心理论依据 | 决策借鉴 |
|---|---|---|
| 季节节气 | 火土旺季原则 | 避冬季水旺克根；选春末夏初（辰、午、未月） |
| 性别推导 | 财官生克链条 | 男命待子孙/财旺之年；女命待财官齐旺之年 |
| 空间博弈 | 内卦动变定内因 | 内卦父母动克世：阻力在家内；外卦财动：机会在外 |
| 变卦指向 | 变卦定结局 | 如无妄→萃：先意外后聚集，磨合等待后可相聚 |

---

## 五、感情占断用神关系补充

### 5.1 伏神受克：缘分枯竭（男占女常见）
- **妻财不现**：必须查伏神与飞神。
- **飞来克伏论**：财伏于兄弟之下，且飞神得气 → 女方被强压。
- **定性**：财被重克且月破/日克 → **命中无缘，强求无果**。

### 5.2 官动化回头克 + 朱雀：动必招灾
- 官鬼动化子孙（子孙克官）= **回头克**：越主动越反弹。
- 官临朱雀发动：主口舌、争吵、名誉受损。
- **结论**：此类卦象主"自寻烦恼"，宜静守避祸。

### 5.3 宫位互克：格局不配的高维定性
- 以本卦/变卦卦宫五行看兼容性。
- 若变卦回头克本卦（如土克水）：
  - 结局对现状是压制与否定 → **格局难配，勉强必崩**。

### 5.4 终极结论表（示例结构）
| 维度 | 象义 | 定性 |
|---|---|---|
| 用神定位 | 财伏且遭飞神重克 | 缘薄无实 |
| 动作后果 | 官动化回头克，临朱雀 | 主动必败，口舌成灾 |
| 性格博弈 | 应克世/世被压 | 一方压制，一方心累 |
| 格局走向 | 变卦宫位回头克 | 天性不合，终分离 |

---

## 六、用神/世应/六神关系补充（结构与细节）

### 6.1 才占世位（男占）：阴阳反背
- 妻财占世位：女方强势掌控，男方被动。
- 财临青龙且旺：女方外形/资源/地位更强，关系易失衡（阴盛阳衰）。

### 6.2 官临白虎且化进：去意已决
- 官鬼临白虎：决绝、急躁、强压。
- 官动化进不回头：趋势不可逆，主"不留恋、跑了"。

### 6.3 旬空定性：空则无心
- 世或用神落旬空：即便生合，也多为**心不实/承诺难落地**。

### 6.4 卦宫克泄与全阴卦：阴阳失衡
- 变卦克本卦：结局压制现状。
- 全阴卦（如萃）：阴盛阳消，久则枯竭，难长久互补。

### 6.5 隐性关系：外爻财星与子孙生合
- 外爻另见财：可能有外缘/二婚/旁支关系线索。
- 子孙生合世财：子嗣为纽带 → 可能"先孕后婚"。

---

## 七、占桃花运补充（暗动、复合、神煞交叉）

### 7.1 暗动判定：月令有根则冲起
- 规则：**日冲之爻，月令有根=暗动；无根=冲破**。
- 含义：缘分先暗后明，地下运行。

### 7.2 官印相生复合断法：功名引动财缘
- "财生官、官生印"链条成：桃花随事业而来。
- 建议：不宜专项求缘，宜"先立业后成家"。

### 7.3 神煞+六亲交叉识别：社交圈干扰
- 桃花临兄弟合世：平辈/朋友圈干扰。
- 是否致命：看官星是否发动制兄（威望/决断能压住干扰）。

### 7.4 木火进气三台阶（应期演变）
1. 春（木旺）：暗动填实，缘由暗转明  
2. 初夏（巳月）：官印爆发，利名分确立  
> 应期看链条先后：财→官→印各环节到位顺序

---

## 八、占感情关系补充：内在关系决定论（总纲）

### 8.1 核心原则
- **内在关系为主，外在信息为辅**
- 世应生克、六合六冲决定感情基调；位分决定权力结构。

### 8.2 深度析法三维
1. **权力结构与性格对位**：财占世/官占位是否错配  
2. **能量流向与动态定数**：旬空识虚情；暗动/化进识趋势  
3. **干扰元素与选择权**：多用神=多选择；以六合+阴阳和谐筛正配

### 8.3 卦象符号辅助
- 卦名义作"场景提示"（如旅卦可应旅行事件）
- 六神修饰：青龙喜、白虎决绝、朱雀口舌
- 卦宫回头克为长期定性参考

---

## 九、"女算男姻缘"核心模型（精简版）

1. **权力架构：世旺克应**  
   - 子孙持世克官：女强男弱，强势压制为根因  
2. **转化损耗：动化官鬼**  
   - 不克而纠缠：女方操劳内耗，久则伤身  
3. **调和生命线：财星通关**  
   - 无财必散；财动/暗动尚存，但以物质精力高代价维持

---

## 十、结婚婚期与抉择：断卦核心理论

### 10.1 婚期定性：官旺见印，岁运并临
- 官动生印：婚事发动、证书名分可落
- 若官为午火，逢午年（马年）官旺 → 典型领证/结婚信号
- 官动亦示摇摆：内心对比未定

### 10.2 现实压力：兄弟动化印回生
- 兄弟动：经济压力/礼金压力显著
- 化印回生：手续、名分推进但成本高

### 10.3 人选博弈：正配 vs 桃花
- 桃花财：漂亮但压力大、华而不实风险
- 正配财：能生世、家庭压力小、合拍度高
- 优选格局：能与世成三合局者（稳家业、助事业）

### 10.4 卦德趋向：小过→损
- 初期口舌琐事多（朱雀）
- 愿意"损"（付出）则可成契约

---

## 十一、女算男感情婚姻补充（泰→升案例提炼）

### 11.1 竞争格局：财多现必有争
- 财多现：多女争男
- 官六合定归属：官合哪财，男心属哪方
- 竞争者动化回头克：竞争者失败≠世必成

### 11.2 本质关系：世鬼相克（性格死证）
- 世与官相克：天生不合、气场冲突
- 世生应的代价：多为自耗迁就，难得等价回报
- 官鬼静：男方无强烈定心/成婚意愿

### 11.3 卦象演变体感
- 泰：表面和气、互不干扰的平衡
- 升：推进费力、爬坡式忍让，磨合成本高

### 11.4 决策简表（口诀）
- **财多现必有竞争，官六合意在他人；世鬼克性格难投，莫强求。**`;

// 其他类规则
const RULE_QITA = `# 其他类问事规则

## 出行择日

### 1）用神选取
- **世爻**：代表出行人
- **应爻**：代表目的地
- 世应相生相合：出行顺利

### 2）忌讳
- 世爻空亡或受克：出行不利
- 官鬼发动：途中有阻碍或意外

## 家居风水

### 1）宅位对应
- 内卦：宅内
- 外卦：宅外
- 二爻：宅基、房屋本体

### 2）吉凶判断
- 二爻旺相：宅基稳固
- 官鬼临二爻：宅内有煞气
- 子孙临二爻：宅内平安`;

// 规则映射
const RULES = {
  caiyun: RULE_CAIYUN,
  shengxue: RULE_SHENGXUE,
  shiye: RULE_SHIYE,
  nianyun: RULE_NIANYUN,
  jiankang: RULE_JIANKANG,
  gushi: RULE_GUSHI,
  ganqing: RULE_GANQING,
  qita: RULE_QITA
};

// ==================== 干支计算工具 ====================

const TIAN_GAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
const DI_ZHI = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
const YAO_NAMES = ['初爻', '二爻', '三爻', '四爻', '五爻', '上爻'];
const LIU_SHEN = ['青龙', '朱雀', '勾陈', '螣蛇', '白虎', '玄武'];

const DIZHI_WUXING = {
  '子': '水', '丑': '土', '寅': '木', '卯': '木',
  '辰': '土', '巳': '火', '午': '火', '未': '土',
  '申': '金', '酉': '金', '戌': '土', '亥': '水'
};

const RIGAN_LIUSHEN_MAP = {
  '甲': 0, '乙': 0, '丙': 1, '丁': 1,
  '戊': 2, '己': 3, '庚': 4, '辛': 4,
  '壬': 5, '癸': 5
};

/**
 * 计算日干支
 */
function getDayGanZhi(date) {
  const baseDate = new Date(1900, 0, 1);
  const diffDays = Math.floor((date - baseDate) / (24 * 60 * 60 * 1000));
  const ganIndex = ((diffDays % 10) + 10) % 10;
  const zhiIndex = ((diffDays + 10) % 12 + 12) % 12;
  return TIAN_GAN[ganIndex] + DI_ZHI[zhiIndex];
}

/**
 * 根据节气获取月份地支索引
 */
function getMonthZhiByJieqi(year, month, day) {
  const jieqiDays = {
    1: 5, 2: 4, 3: 6, 4: 5, 5: 6, 6: 6,
    7: 7, 8: 8, 9: 8, 10: 8, 11: 7, 12: 7
  };
  const monthToZhi = {
    1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6,
    7: 7, 8: 8, 9: 9, 10: 10, 11: 11, 12: 0
  };
  
  if (day >= jieqiDays[month]) {
    return monthToZhi[month];
  } else {
    const prevMonth = month === 1 ? 12 : month - 1;
    return monthToZhi[prevMonth];
  }
}

/**
 * 计算月干支
 */
function getMonthGanZhi(year, month, day) {
  const monthZhiIndex = getMonthZhiByJieqi(year, month, day);
  let yearForGan = year;
  if (month < 2 || (month === 2 && day < 4)) {
    yearForGan = year - 1;
  }
  const yearGanIndex = ((yearForGan - 4) % 10 + 10) % 10;
  const yinMonthGanStart = [2, 4, 6, 8, 0, 2, 4, 6, 8, 0];
  let monthOffset = monthZhiIndex - 2;
  if (monthOffset < 0) monthOffset += 12;
  const monthGanIndex = (yinMonthGanStart[yearGanIndex] + monthOffset) % 10;
  return TIAN_GAN[monthGanIndex] + DI_ZHI[monthZhiIndex];
}

/**
 * 获取农历日期字符串
 */
function getLunarDate(date) {
  const now = date || new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const dayGanZhi = getDayGanZhi(now);
  const monthGanZhi = getMonthGanZhi(year, month, day);
  return `${monthGanZhi}月${dayGanZhi}日`;
}

/**
 * 计算六亲
 */
function calculateLiuqin(palaceWuxing, yaoWuxing) {
  const sheng = { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' };
  const beiSheng = { '火': '木', '土': '火', '金': '土', '水': '金', '木': '水' };
  const ke = { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' };
  const beiKe = { '土': '木', '水': '土', '火': '水', '金': '火', '木': '金' };
  
  if (yaoWuxing === palaceWuxing) return '兄弟';
  if (beiSheng[palaceWuxing] === yaoWuxing) return '父母';
  if (sheng[palaceWuxing] === yaoWuxing) return '子孙';
  if (beiKe[palaceWuxing] === yaoWuxing) return '官鬼';
  if (ke[palaceWuxing] === yaoWuxing) return '妻财';
  return '未知';
}

/**
 * 计算六神数组
 */
function calculateLiuShen(date) {
  const now = date || new Date();
  const dayGanZhi = getDayGanZhi(now);
  const dayGan = dayGanZhi[0];
  const startIndex = RIGAN_LIUSHEN_MAP[dayGan];
  const liuShenArray = [];
  for (let i = 0; i < 6; i++) {
    liuShenArray.push(LIU_SHEN[(startIndex + i) % 6]);
  }
  return liuShenArray;
}

// ==================== 提示词生成 ====================

/**
 * 根据问题分类获取规则内容
 */
function getRuleByCategory(categoryName) {
  const ruleType = CATEGORY_RULE_MAP[categoryName] || 'nianyun';
  console.log(`[getRuleByCategory] 分类名: "${categoryName}" => 规则类型: "${ruleType}"`);
  console.log(`[getRuleByCategory] 规则内容长度: ${RULES[ruleType] ? RULES[ruleType].length : 0}`);
  return RULES[ruleType] || RULES.nianyun;
}

/**
 * 生成AI解卦提示词
 * @param {object} params - 解卦参数
 */
function generateAIPrompt(params) {
  const { 
    question, 
    benGuaInfo, 
    bianGuaInfo, 
    yaos, 
    movingPositions, 
    questionCategory,
    gender 
  } = params;
  
  const lunarDate = getLunarDate();
  const palaceWuxing = benGuaInfo.wuxing;
  const liuShenArray = calculateLiuShen();
  
  // 获取规则内容
  console.log(`[generateAIPrompt] 接收到 questionCategory: "${questionCategory}"`);
  const ruleContent = questionCategory ? getRuleByCategory(questionCategory) : '';
  console.log(`[generateAIPrompt] 规则内容前50字符: ${ruleContent.substring(0, 50)}...`);
  
  // 性别描述
  const genderDesc = gender === 'male' ? '（男性求卦）' : gender === 'female' ? '（女性求卦）' : '';
  
  let prompt = `我要问"${question}"的问题${genderDesc}：\n`;
  prompt += `在农历${lunarDate}问事，得到${benGuaInfo.name}（${benGuaInfo.palace}，属${benGuaInfo.wuxing}）为本卦`;
  
  const movingSet = new Set(movingPositions || []);
  
  if (movingPositions && movingPositions.length > 0 && bianGuaInfo) {
    prompt += `，变卦为${bianGuaInfo.name}（${bianGuaInfo.palace}，属${bianGuaInfo.wuxing}）。`;
  } else if (movingPositions && movingPositions.length > 0) {
    prompt += `，有动爻（变卦信息未提供）。`;
  } else {
    prompt += `，无动爻（静卦）。`;
  }
  
  // 卦辞
  prompt += `\n\n【卦辞】${benGuaInfo.info}`;
  
  // 世应信息
  prompt += `\n【世应】世爻在第${benGuaInfo.shi}爻，应爻在第${benGuaInfo.ying}爻`;
  
  // 本卦六爻详细信息
  prompt += `\n\n【本卦六爻信息】（${benGuaInfo.name}）`;
  for (let i = 5; i >= 0; i--) {
    const yaoName = YAO_NAMES[i];
    const yaoType = yaos[i].value === 1 ? '阳' : '阴';
    const dizhi = benGuaInfo.dizhi[i];
    const wuxing = benGuaInfo.wuxingYao[i];
    const liuqin = benGuaInfo.liuqin[i];
    const liuShen = liuShenArray[i];
    const isMoving = movingSet.has(i + 1);
    const isShiYao = benGuaInfo.shi === (i + 1);
    const isYingYao = benGuaInfo.ying === (i + 1);
    
    let yaoDesc = `\n${yaoName}：${liuShen} ${yaoType}爻，${liuqin}${dizhi}${wuxing}`;
    
    if (isShiYao) yaoDesc += '（世）';
    if (isYingYao) yaoDesc += '（应）';
    
    if (isMoving) {
      const changeToType = yaos[i].value === 1 ? '阴' : '阳';
      yaoDesc += ` → 动爻（${yaoType}变${changeToType}）`;
    }
    
    prompt += yaoDesc;
  }
  
  // 变卦六爻详细信息
  if (movingPositions && movingPositions.length > 0 && bianGuaInfo) {
    prompt += `\n\n【变卦六爻信息】（${bianGuaInfo.name}，六亲以本卦${benGuaInfo.palace}${palaceWuxing}推算）`;
    for (let i = 5; i >= 0; i--) {
      const yaoName = YAO_NAMES[i];
      const originalValue = yaos[i].value;
      const isMoving = movingSet.has(i + 1);
      const newValue = isMoving ? (originalValue === 1 ? 0 : 1) : originalValue;
      const yaoType = newValue === 1 ? '阳' : '阴';
      
      const dizhi = bianGuaInfo.dizhi[i];
      const wuxing = bianGuaInfo.wuxingYao[i];
      const liuqin = calculateLiuqin(palaceWuxing, wuxing);
      const liuShen = liuShenArray[i];
      
      let yaoDesc = `\n${yaoName}：${liuShen} ${yaoType}爻，${liuqin}${dizhi}${wuxing}`;
      
      if (isMoving) {
        yaoDesc += ' ← 变爻';
      }
      
      prompt += yaoDesc;
    }
  }
  
  prompt += `\n\n请帮忙用增删卜易推算此卦的结果和走向，分析六亲关系、世应、六神、动爵变化对问事的影响。`;
  
  // 禁忌事项
  prompt += `\n\n【总原则 - 禁忌事项】
以下情况不可解卦，需告知用户这是禁忌，即使解读结果也不准确：
1. 不是自己的事情不能算 - 与自身无直接关系之事，不可代人起卦
2. 家人以外的人不能帮算 - 非直系或亲近家人之事，不宜代算
3. 不符合正道、正能量的不能算 - 动机不正之事不可算（如婚外情、不道德的情感纠葛、损人利己之事）
4. 犯罪、违法的事情不能算 - 涉及违法、犯罪、灰色行为的事情
若发现所问问题触及以上禁忌，请不要进行解读，而是友善地告知用户这属于禁忌范畴。`;
  
  // 双版本输出要求
  prompt += `\n\n【输出格式要求 - 双版本解读】
请生成两份解读内容：

一、专业版解读（给专业人士）
- 表达自然，不带任何AI相关信息或痕迹
- 语言风格贴近传统师承、实务经验总结
- 可使用业内通行的术语与行话
- 注重逻辑严谨与内在一致性，不做科普解释

二、通俗版解读（给普通用户）
- 表达直白、自然、生活化
- 不出现任何算卦流派、书名或专业分析术语
- 使用日常语言说明结论，侧重结果、建议和注意事项
- 让用户感觉是在"被提醒、被建议"，而非"被分析"

统一原则：不出现AI、自称、模型等表述，语气自然，像人写的。`;
  
  // 规则内容
  if (ruleContent) {
    prompt += `\n\n【解卦参考规则】\n请根据以下规则进行解卦分析：\n\n${ruleContent}`;
  }
  
  // 强制中文输出
  prompt += `\n\n【语言要求】\n- 必须使用简体中文回复，禁止使用英文\n- 禁止输出思考过程、推理过程或任何 <think> 标签\n- 直接输出最终分析结果`;

  return prompt;
}

export {
  CATEGORY_RULE_MAP,
  RULES,
  getRuleByCategory,
  generateAIPrompt,
  getLunarDate,
  calculateLiuqin,
  calculateLiuShen
};